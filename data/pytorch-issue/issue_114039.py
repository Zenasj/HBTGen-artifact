import torch
import torchvision
import torchvision.transforms as transforms
import torch.nn as nn
import os
import torch.nn.functional as F
gpu_device = torch.device("cuda")
cpu_device = torch.device("cpu")
class PreprocessAndCalculateModel(nn.Module):
    def __init__(self):
        super().__init__()
        self.batchnorm2d = nn.BatchNorm2d(3)
    def forward(self, x):
        x = self.batchnorm2d(x)
        output = torch.cholesky_inverse(x)
        return output

real_inputs = torch.Tensor([[[[0.2240, 0.9476, 0.8421, 0.8342, 0.4564, 0.5623, 0.7141, 0.4341],
          [0.6533, 0.2074, 0.0383, 0.4968, 0.6462, 0.4133, 0.2097, 0.5010],
          [0.4120, 0.3860, 0.9584, 0.4990, 0.7222, 0.9410, 0.1034, 0.8788],
          [0.9356, 0.7212, 0.5616, 0.4320, 0.5662, 0.6225, 0.6705, 0.6396],
          [0.9126, 0.3528, 0.9105, 0.1270, 0.0558, 0.8415, 0.6832, 0.9981],
          [0.5335, 0.6126, 0.8327, 0.1218, 0.6810, 0.0491, 0.9968, 0.4534],
          [0.1870, 0.4975, 0.5207, 0.9253, 0.6885, 0.0437, 0.5921, 0.9172],
          [0.6123, 0.0057, 0.6387, 0.7819, 0.6381, 0.1307, 0.9552, 0.8950]],

         [[0.6805, 0.8004, 0.1763, 0.3093, 0.8344, 0.9650, 0.5749, 0.4664],
          [0.0493, 0.0745, 0.7223, 0.7164, 0.6397, 0.0361, 0.6799, 0.9908],
          [0.7225, 0.0737, 0.6308, 0.3240, 0.1453, 0.5940, 0.6537, 0.2041],
          [0.0323, 0.0107, 0.5517, 0.8604, 0.1640, 0.8566, 0.3017, 0.5885],
          [0.2383, 0.6409, 0.9845, 0.8003, 0.4982, 0.3723, 0.9504, 0.3409],
          [0.1701, 0.6251, 0.1069, 0.8454, 0.3169, 0.5615, 0.3014, 0.0486],
          [0.0314, 0.1601, 0.4312, 0.3808, 0.8861, 0.7072, 0.7473, 0.8453],
          [0.7347, 0.9867, 0.4679, 0.9198, 0.1491, 0.7059, 0.1237, 0.3763]],

         [[0.2624, 0.6102, 0.6051, 0.9559, 0.8150, 0.5216, 0.7010, 0.7266],
          [0.2860, 0.2635, 0.1336, 0.5976, 0.5293, 0.5441, 0.2680, 0.8344],
          [0.9289, 0.6752, 0.3102, 0.0739, 0.2169, 0.8270, 0.6343, 0.9948],
          [0.9655, 0.4389, 0.5885, 0.1671, 0.5078, 0.8435, 0.0497, 0.1516],
          [0.8836, 0.6395, 0.7557, 0.8757, 0.1430, 0.5019, 0.5763, 0.4952],
          [0.1401, 0.8952, 0.3508, 0.0042, 0.8209, 0.4203, 0.7072, 0.5572],
          [0.8573, 0.9425, 0.3299, 0.0190, 0.5072, 0.4210, 0.6962, 0.7229],
          [0.8663, 0.2342, 0.3679, 0.7155, 0.3520, 0.5703, 0.6369, 0.5307]]],


        [[[0.6324, 0.2042, 0.0093, 0.8036, 0.9148, 0.3379, 0.6336, 0.6218],
          [0.9827, 0.7053, 0.8387, 0.6959, 0.4768, 0.5565, 0.4956, 0.1274],
          [0.4052, 0.7991, 0.6821, 0.3055, 0.2857, 0.6949, 0.9921, 0.7012],
          [0.6637, 0.6749, 0.4580, 0.4372, 0.2503, 0.1904, 0.8061, 0.8184],
          [0.2307, 0.5870, 0.1886, 0.4570, 0.2639, 0.4597, 0.9427, 0.5315],
          [0.5661, 0.4324, 0.4793, 0.1057, 0.8022, 0.2929, 0.3085, 0.5323],
          [0.2088, 0.4903, 0.4289, 0.3931, 0.2349, 0.1763, 0.7978, 0.0062],
          [0.1324, 0.6460, 0.5402, 0.7848, 0.4312, 0.2911, 0.8253, 0.9240]],

         [[0.8395, 0.8903, 0.1272, 0.3060, 0.2714, 0.5520, 0.2106, 0.9743],
          [0.5608, 0.4585, 0.7823, 0.7002, 0.6495, 0.8593, 0.7692, 0.9120],
          [0.6524, 0.7356, 0.2817, 0.2779, 0.3158, 0.8602, 0.7275, 0.7251],
          [0.4524, 0.2348, 0.6473, 0.3339, 0.7808, 0.1365, 0.5537, 0.3432],
          [0.3551, 0.4066, 0.2755, 0.6479, 0.9354, 0.4649, 0.1415, 0.7268],
          [0.7356, 0.0016, 0.9316, 0.0877, 0.2622, 0.0133, 0.5316, 0.4238],
          [0.4825, 0.8606, 0.9680, 0.5860, 0.1483, 0.1706, 0.6186, 0.5032],
          [0.0471, 0.8428, 0.8026, 0.3220, 0.1047, 0.5784, 0.4483, 0.4639]],

         [[0.5309, 0.2626, 0.4425, 0.9145, 0.5108, 0.6315, 0.5647, 0.2827],
          [0.6392, 0.7816, 0.1160, 0.9904, 0.4975, 0.0846, 0.7355, 0.0731],
          [0.1137, 0.8207, 0.5676, 0.7107, 0.1234, 0.6383, 0.2164, 0.3827],
          [0.4136, 0.5965, 0.5083, 0.9275, 0.7684, 0.9535, 0.3643, 0.2708],
          [0.9544, 0.5863, 0.3491, 0.8836, 0.6371, 0.9120, 0.3120, 0.3551],
          [0.8294, 0.6466, 0.3683, 0.6781, 0.2246, 0.1447, 0.8506, 0.5114],
          [0.4459, 0.2612, 0.2579, 0.8648, 0.1785, 0.9912, 0.4598, 0.3520],
          [0.1508, 0.1355, 0.6937, 0.6904, 0.9343, 0.6129, 0.4254, 0.1322]]]])
model = PreprocessAndCalculateModel()
x = real_inputs
output_gpu = model.to(gpu_device)(x.cuda())
output_cpu = model.to(cpu_device)(x.cpu())

print(torch.allclose(output_gpu.cpu(), output_cpu, atol=1e-1))
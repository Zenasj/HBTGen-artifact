import torch
import numpy as np

A = np.array([[ 1.60782897e+00,  2.28964731e-01,  5.37528796e-03, -3.68031830e-01,  7.76133314e-02,  1.95910275e-01, -3.12402956e-02,  3.67419720e-01,  1.22131474e-01, -2.53661489e+00,  2.17903289e-06,  5.94051089e-05,  2.33369647e-05, -3.33767384e-04,  7.98902474e-05,  9.64686275e-04, -4.88465303e-04,  2.36044801e-03,  4.49522515e-04, -4.29443026e+00],
       [ 2.28964731e-01,  2.41090322e+00, -1.88907310e-02, -1.11321688e+00,  2.24941388e-01,  5.75562716e-01, -1.19260252e-01,  1.07684803e+00,  3.36590528e-01, -5.06800270e+00, -2.24896939e-06, -4.84753400e-06, -7.50925392e-06,  1.13487244e-04, -3.26065347e-05, -4.61697578e-04,  3.01518885e-04, -1.26068108e-03,  9.04885674e-05,  1.70146358e+00],
       [ 5.37528796e-03, -1.88907310e-02,  1.62140822e+00, -1.66513994e-02, -1.20639233e-02,  2.17823274e-02,  2.43900251e-03,  2.59594470e-02, -1.06401583e-02,  1.67924047e-01,  2.05849938e-06,  2.44657276e-05,  1.31483248e-05, -1.48024876e-04,  6.39846548e-05,  5.71987592e-04,  3.61403363e-06,  1.01836876e-03,  1.68582925e-03, -3.52031112e+00],
       [-3.68031830e-01, -1.11321688e+00, -1.66513994e-02,  3.52388382e+00, -3.89591247e-01, -8.86485994e-01,  3.69597822e-01, -2.19188643e+00, -4.24265265e-01,  3.27274895e+00, -2.42434326e-05, -2.98958272e-04, -1.23632257e-04,  1.87904201e-03, -5.15639316e-04, -5.35614789e-03,  2.87756487e-03, -1.53830992e-02, -4.53177467e-03,  2.52128124e+01],
       [ 7.76133314e-02,  2.24941388e-01, -1.20639233e-02, -3.89591247e-01,  1.93465853e+00,  2.48911351e-01, -2.28518508e-02,  4.19600159e-01,  1.34637073e-01,  4.95270640e-01,  2.64251721e-05,  3.15882266e-04,  1.41064636e-04, -1.91451237e-03,  6.46093860e-04,  6.21308386e-03, -2.34547607e-03,  1.57597680e-02,  8.13580025e-03, -3.23177299e+01],
       [ 1.95910275e-01,  5.75562716e-01,  2.17823274e-02, -8.86485994e-01,  2.48911351e-01,  2.98399925e+00, -4.25876319e-01,  9.31742251e-01, -4.73557204e-01,  9.36427712e-01,  1.56900787e-05,  1.95616623e-04,  9.17701400e-05, -1.15976110e-03,  4.29244712e-04,  4.25980613e-03, -8.00579088e-04,  8.80736019e-03,  8.03760253e-03, -2.24972534e+01],
       [-3.12402956e-02, -1.19260252e-01,  2.43900251e-03,  3.69597822e-01, -2.28518508e-02, -4.25876319e-01,  3.06580067e+00, -6.48983538e-01,  4.06311929e-01,  1.37230349e+00,  7.44865829e-05,  8.81816493e-04,  3.89039924e-04, -5.36584575e-03,  1.68655277e-03,  1.71863157e-02, -5.95929101e-03,  4.48325910e-02,  2.24911068e-02, -8.79636688e+01],
       [ 3.67419720e-01,  1.07684803e+00,  2.59594470e-02, -2.19188643e+00,  4.19600159e-01,  9.31742251e-01, -6.48983538e-01,  5.48731613e+00, -6.58562034e-02, -2.43317747e+00, -2.27659766e-05, -2.60235975e-04, -1.24252401e-04,  1.58591196e-03, -5.84547408e-04, -5.63996658e-03,  1.13803300e-03, -1.05895922e-02, -1.21539282e-02,  2.72431316e+01],
       [ 1.22131474e-01,  3.36590528e-01, -1.06401583e-02, -4.24265265e-01,  1.34637073e-01, -4.73557204e-01,  4.06311929e-01, -6.58562034e-02,  5.43583727e+00, -2.92779040e+00,  2.11733277e-06,  3.67360190e-05,  3.78659461e-05, -1.60590280e-04,  2.01643910e-04,  1.61331519e-03,  1.96514279e-03, -1.50358269e-03,  1.71575230e-02, -1.18784990e+01],
       [-2.53661489e+00, -5.06800270e+00,  1.67924047e-01,  3.27274895e+00,  4.95270640e-01,  9.36427712e-01,  1.37230349e+00, -2.43317747e+00, -2.92779040e+00,  8.76316345e+02, -1.22874253e-03, -1.46462396e-02, -6.36728108e-03,  8.91621411e-02, -2.74890810e-02, -2.80071974e-01,  1.21408194e-01, -7.62682676e-01, -3.09633642e-01,  1.52729504e+03],
       [ 2.17903289e-06, -2.24896939e-06,  2.05849938e-06, -2.42434326e-05,  2.64251721e-05,  1.56900787e-05,  7.44865829e-05, -2.27659766e-05,  2.11733277e-06, -1.22874253e-03,  1.33819203e-03,  1.58352833e-02,  6.75189588e-03, -9.70604271e-02,  2.87030358e-02,  2.97664732e-01, -1.43668085e-01,  8.35517287e-01,  2.84892887e-01, -1.46552661e+03],
       [ 5.94051089e-05, -4.84753400e-06,  2.44657276e-05, -2.98958272e-04,  3.15882266e-04,  1.95616623e-04,  8.81816493e-04, -2.60235975e-04,  3.67360190e-05, -1.46462396e-02,  1.58352833e-02,  1.87388241e-01,  7.99007788e-02, -1.14855564e+00,  3.39666307e-01,  3.52251792e+00, -1.69990075e+00,  9.88676643e+00,  3.37287593e+00, -1.73432988e+04],
       [ 2.33369647e-05, -7.50925392e-06,  1.31483248e-05, -1.23632257e-04,  1.41064636e-04,  9.17701400e-05,  3.89039924e-04, -1.24252401e-04,  3.78659461e-05, -6.36728108e-03,  6.75189588e-03,  7.99007788e-02,  3.40821631e-02, -4.89710629e-01,  1.44927666e-01,  1.50249171e+00, -7.23849893e-01,  4.21417427e+00,  1.44301021e+00, -7.40001318e+03],
       [-3.33767384e-04,  1.13487244e-04, -1.48024876e-04,  1.87904201e-03, -1.91451237e-03, -1.15976110e-03, -5.36584575e-03,  1.58591196e-03, -1.60590280e-04,  8.91621411e-02, -9.70604271e-02, -1.14855564e+00, -4.89710629e-01,  7.04013824e+00, -2.08170390e+00, -2.15894566e+01,  1.04222698e+01, -6.06031189e+01, -2.06613407e+01,  1.06286359e+05],
       [ 7.98902474e-05, -3.26065347e-05,  6.39846548e-05, -5.15639316e-04,  6.46093860e-04,  4.29244712e-04,  1.68655277e-03, -5.84547408e-04,  2.01643910e-04, -2.74890810e-02,  2.87030358e-02,  3.39666307e-01,  1.44927666e-01, -2.08170390e+00,  6.16610885e-01,  6.38967180e+00, -3.07360172e+00,  1.79079399e+01,  6.14985657e+00, -3.14770039e+04],
       [ 9.64686275e-04, -4.61697578e-04,  5.71987592e-04, -5.35614789e-03,  6.21308386e-03,  4.25980613e-03,  1.71863157e-02, -5.63996658e-03,  1.61331519e-03, -2.80071974e-01,  2.97664732e-01,  3.52251792e+00,  1.50249171e+00, -2.15894566e+01,  6.38967180e+00,  6.62452698e+01, -3.19060764e+01,  1.85773941e+02,  6.36354866e+01, -3.26240062e+05],
       [-4.86891717e-04,  3.01372260e-04,  3.62051651e-06,  2.87755951e-03, -2.34574080e-03, -8.00948590e-04, -5.95919322e-03,  1.13837048e-03,  1.96490344e-03,  1.21410340e-01, -1.43668100e-01, -1.69990110e+00, -7.23848820e-01,  1.04222832e+01, -3.07360816e+00, -3.19060802e+01,  1.55375633e+01, -8.98448792e+01, -3.00951061e+01,  1.56913156e+05],
       [ 2.37344205e-03, -1.26130879e-03,  1.01752952e-03, -1.53824687e-02,  1.57596469e-02,  8.80961865e-03,  4.48332652e-02, -1.05940849e-02, -1.50594860e-03, -7.62646675e-01,  8.35519135e-01,  9.88673401e+00,  4.21416092e+00, -6.06031990e+01,  1.79079304e+01,  1.85773956e+02, -8.98448792e+01,  5.21939880e+02,  1.77149094e+02, -9.14563250e+05],
       [ 4.47247177e-04,  9.06437635e-05,  1.68623496e-03, -4.53158468e-03,  8.13601911e-03,  8.03825632e-03,  2.24906951e-02, -1.21534169e-02,  1.71582494e-02, -3.09652269e-01,  2.84893215e-01,  3.37288260e+00,  1.44301367e+00, -2.06612988e+01,  6.14986134e+00,  6.36355400e+01, -3.00951061e+01,  1.77149094e+02,  6.36062050e+01, -3.14022406e+05],
       [-4.30882263e+00,  1.70046997e+00, -3.52318573e+00,  2.52160645e+01, -3.23214111e+01, -2.25007477e+01, -8.79653473e+01,  2.72448120e+01, -1.18774796e+01,  1.52729688e+03, -1.46553210e+03, -1.73432891e+04, -7.40001074e+03,  1.06286719e+05, -3.14769004e+04, -3.26239531e+05,  1.56913156e+05, -9.14563250e+05, -3.14022406e+05,  1.60835072e+09]], dtype=np.float32)
A = A + A.T # symmetrize

L, Q = np.linalg.eigh(A)
meo = Q @ np.diag(L) @ Q.T
print('numpy:', np.max(np.abs(Q @ np.diag(L) @ Q.T - A) / A))  # 1e-5 GOOD

L, Q = torch.linalg.eigh(torch.from_numpy(A))
print('torch cpu:', torch.max(torch.abs(Q @ torch.diag(L) @ Q.T - A) / A).item()) # 1584 BAD

L, Q = torch.linalg.eigh(torch.from_numpy(A), UPLO="U")
print('torch cpu upper:', torch.max(torch.abs(Q @ torch.diag(L) @ Q.T - A) / A).item())  # 0.11 OKAY

A_cuda = torch.from_numpy(A).to("cuda:0")
L, Q = torch.linalg.eigh(A_cuda)
print('torch gpu:', torch.max(torch.abs((Q @ torch.diag(L) @ Q.T) - A_cuda) / A_cuda).item())  # 18295 BAD

L, Q = torch.linalg.eigh(A_cuda, UPLO="U")
print('torch gpu upper:', torch.max(torch.abs((Q @ torch.diag(L) @ Q.T) - A_cuda) / A_cuda).item())  # 4687 BAD

import torch
import numpy as np
import pandas as pd

A = np.array(
    [[ 1.60782897e+00,  2.28964731e-01,  5.37528796e-03, -3.68031830e-01,  7.76133314e-02,  1.95910275e-01, -3.12402956e-02,  3.67419720e-01,  1.22131474e-01, -2.53661489e+00,  2.17903289e-06,  5.94051089e-05,  2.33369647e-05, -3.33767384e-04,  7.98902474e-05,  9.64686275e-04, -4.88465303e-04,  2.36044801e-03,  4.49522515e-04, -4.29443026e+00],
     [ 2.28964731e-01,  2.41090322e+00, -1.88907310e-02, -1.11321688e+00,  2.24941388e-01,  5.75562716e-01, -1.19260252e-01,  1.07684803e+00,  3.36590528e-01, -5.06800270e+00, -2.24896939e-06, -4.84753400e-06, -7.50925392e-06,  1.13487244e-04, -3.26065347e-05, -4.61697578e-04,  3.01518885e-04, -1.26068108e-03,  9.04885674e-05,  1.70146358e+00],
     [ 5.37528796e-03, -1.88907310e-02,  1.62140822e+00, -1.66513994e-02, -1.20639233e-02,  2.17823274e-02,  2.43900251e-03,  2.59594470e-02, -1.06401583e-02,  1.67924047e-01,  2.05849938e-06,  2.44657276e-05,  1.31483248e-05, -1.48024876e-04,  6.39846548e-05,  5.71987592e-04,  3.61403363e-06,  1.01836876e-03,  1.68582925e-03, -3.52031112e+00],
     [-3.68031830e-01, -1.11321688e+00, -1.66513994e-02,  3.52388382e+00, -3.89591247e-01, -8.86485994e-01,  3.69597822e-01, -2.19188643e+00, -4.24265265e-01,  3.27274895e+00, -2.42434326e-05, -2.98958272e-04, -1.23632257e-04,  1.87904201e-03, -5.15639316e-04, -5.35614789e-03,  2.87756487e-03, -1.53830992e-02, -4.53177467e-03,  2.52128124e+01],
     [ 7.76133314e-02,  2.24941388e-01, -1.20639233e-02, -3.89591247e-01,  1.93465853e+00,  2.48911351e-01, -2.28518508e-02,  4.19600159e-01,  1.34637073e-01,  4.95270640e-01,  2.64251721e-05,  3.15882266e-04,  1.41064636e-04, -1.91451237e-03,  6.46093860e-04,  6.21308386e-03, -2.34547607e-03,  1.57597680e-02,  8.13580025e-03, -3.23177299e+01],
     [ 1.95910275e-01,  5.75562716e-01,  2.17823274e-02, -8.86485994e-01,  2.48911351e-01,  2.98399925e+00, -4.25876319e-01,  9.31742251e-01, -4.73557204e-01,  9.36427712e-01,  1.56900787e-05,  1.95616623e-04,  9.17701400e-05, -1.15976110e-03,  4.29244712e-04,  4.25980613e-03, -8.00579088e-04,  8.80736019e-03,  8.03760253e-03, -2.24972534e+01],
     [-3.12402956e-02, -1.19260252e-01,  2.43900251e-03,  3.69597822e-01, -2.28518508e-02, -4.25876319e-01,  3.06580067e+00, -6.48983538e-01,  4.06311929e-01,  1.37230349e+00,  7.44865829e-05,  8.81816493e-04,  3.89039924e-04, -5.36584575e-03,  1.68655277e-03,  1.71863157e-02, -5.95929101e-03,  4.48325910e-02,  2.24911068e-02, -8.79636688e+01],
     [ 3.67419720e-01,  1.07684803e+00,  2.59594470e-02, -2.19188643e+00,  4.19600159e-01,  9.31742251e-01, -6.48983538e-01,  5.48731613e+00, -6.58562034e-02, -2.43317747e+00, -2.27659766e-05, -2.60235975e-04, -1.24252401e-04,  1.58591196e-03, -5.84547408e-04, -5.63996658e-03,  1.13803300e-03, -1.05895922e-02, -1.21539282e-02,  2.72431316e+01],
     [ 1.22131474e-01,  3.36590528e-01, -1.06401583e-02, -4.24265265e-01,  1.34637073e-01, -4.73557204e-01,  4.06311929e-01, -6.58562034e-02,  5.43583727e+00, -2.92779040e+00,  2.11733277e-06,  3.67360190e-05,  3.78659461e-05, -1.60590280e-04,  2.01643910e-04,  1.61331519e-03,  1.96514279e-03, -1.50358269e-03,  1.71575230e-02, -1.18784990e+01],
     [-2.53661489e+00, -5.06800270e+00,  1.67924047e-01,  3.27274895e+00,  4.95270640e-01,  9.36427712e-01,  1.37230349e+00, -2.43317747e+00, -2.92779040e+00,  8.76316345e+02, -1.22874253e-03, -1.46462396e-02, -6.36728108e-03,  8.91621411e-02, -2.74890810e-02, -2.80071974e-01,  1.21408194e-01, -7.62682676e-01, -3.09633642e-01,  1.52729504e+03],
     [ 2.17903289e-06, -2.24896939e-06,  2.05849938e-06, -2.42434326e-05,  2.64251721e-05,  1.56900787e-05,  7.44865829e-05, -2.27659766e-05,  2.11733277e-06, -1.22874253e-03,  1.33819203e-03,  1.58352833e-02,  6.75189588e-03, -9.70604271e-02,  2.87030358e-02,  2.97664732e-01, -1.43668085e-01,  8.35517287e-01,  2.84892887e-01, -1.46552661e+03],
     [ 5.94051089e-05, -4.84753400e-06,  2.44657276e-05, -2.98958272e-04,  3.15882266e-04,  1.95616623e-04,  8.81816493e-04, -2.60235975e-04,  3.67360190e-05, -1.46462396e-02,  1.58352833e-02,  1.87388241e-01,  7.99007788e-02, -1.14855564e+00,  3.39666307e-01,  3.52251792e+00, -1.69990075e+00,  9.88676643e+00,  3.37287593e+00, -1.73432988e+04],
     [ 2.33369647e-05, -7.50925392e-06,  1.31483248e-05, -1.23632257e-04,  1.41064636e-04,  9.17701400e-05,  3.89039924e-04, -1.24252401e-04,  3.78659461e-05, -6.36728108e-03,  6.75189588e-03,  7.99007788e-02,  3.40821631e-02, -4.89710629e-01,  1.44927666e-01,  1.50249171e+00, -7.23849893e-01,  4.21417427e+00,  1.44301021e+00, -7.40001318e+03],
     [-3.33767384e-04,  1.13487244e-04, -1.48024876e-04,  1.87904201e-03, -1.91451237e-03, -1.15976110e-03, -5.36584575e-03,  1.58591196e-03, -1.60590280e-04,  8.91621411e-02, -9.70604271e-02, -1.14855564e+00, -4.89710629e-01,  7.04013824e+00, -2.08170390e+00, -2.15894566e+01,  1.04222698e+01, -6.06031189e+01, -2.06613407e+01,  1.06286359e+05],
     [ 7.98902474e-05, -3.26065347e-05,  6.39846548e-05, -5.15639316e-04,  6.46093860e-04,  4.29244712e-04,  1.68655277e-03, -5.84547408e-04,  2.01643910e-04, -2.74890810e-02,  2.87030358e-02,  3.39666307e-01,  1.44927666e-01, -2.08170390e+00,  6.16610885e-01,  6.38967180e+00, -3.07360172e+00,  1.79079399e+01,  6.14985657e+00, -3.14770039e+04],
     [ 9.64686275e-04, -4.61697578e-04,  5.71987592e-04, -5.35614789e-03,  6.21308386e-03,  4.25980613e-03,  1.71863157e-02, -5.63996658e-03,  1.61331519e-03, -2.80071974e-01,  2.97664732e-01,  3.52251792e+00,  1.50249171e+00, -2.15894566e+01,  6.38967180e+00,  6.62452698e+01, -3.19060764e+01,  1.85773941e+02,  6.36354866e+01, -3.26240062e+05],
     [-4.86891717e-04,  3.01372260e-04,  3.62051651e-06,  2.87755951e-03, -2.34574080e-03, -8.00948590e-04, -5.95919322e-03,  1.13837048e-03,  1.96490344e-03,  1.21410340e-01, -1.43668100e-01, -1.69990110e+00, -7.23848820e-01,  1.04222832e+01, -3.07360816e+00, -3.19060802e+01,  1.55375633e+01, -8.98448792e+01, -3.00951061e+01,  1.56913156e+05],
     [ 2.37344205e-03, -1.26130879e-03,  1.01752952e-03, -1.53824687e-02,  1.57596469e-02,  8.80961865e-03,  4.48332652e-02, -1.05940849e-02, -1.50594860e-03, -7.62646675e-01,  8.35519135e-01,  9.88673401e+00,  4.21416092e+00, -6.06031990e+01,  1.79079304e+01,  1.85773956e+02, -8.98448792e+01,  5.21939880e+02,  1.77149094e+02, -9.14563250e+05],
     [ 4.47247177e-04,  9.06437635e-05,  1.68623496e-03, -4.53158468e-03,  8.13601911e-03,  8.03825632e-03,  2.24906951e-02, -1.21534169e-02,  1.71582494e-02, -3.09652269e-01,  2.84893215e-01,  3.37288260e+00,  1.44301367e+00, -2.06612988e+01,  6.14986134e+00,  6.36355400e+01, -3.00951061e+01,  1.77149094e+02,  6.36062050e+01, -3.14022406e+05],
     [-4.30882263e+00,  1.70046997e+00, -3.52318573e+00,  2.52160645e+01, -3.23214111e+01, -2.25007477e+01, -8.79653473e+01,  2.72448120e+01, -1.18774796e+01,  1.52729688e+03, -1.46553210e+03, -1.73432891e+04, -7.40001074e+03,  1.06286719e+05, -3.14769004e+04, -3.26239531e+05,  1.56913156e+05, -9.14563250e+05, -3.14022406e+05,  1.60835072e+09]]
)
N, _ = A.shape
A64 = A + A.T # symmetrize
A32 = A64.astype(np.float32)
print(np.linalg.cond(A64))
del A

eps = 1e-6
# 
relerr_np = lambda x, y: (np.abs(x-y) / (np.abs(y) + eps)).max()
relerr = lambda x, y: ((x-y).abs() / (y.abs() + eps)).max().item()

results = pd.DataFrame(columns=["A", "L", "Q"], index=["numpy64", "numpy32", "cpu", "cpu+upper", "gpu", "gpu+upper"])

L, Q = np.linalg.eigh(A64)
A2 = Q @ np.diag(L) @ Q.T
results.loc["numpy64"] = [relerr_np(A2, A64), relerr_np(np.diag(L)@Q.T, Q.T @ A64), relerr_np(Q@Q.T, np.eye(N))]

L, Q = np.linalg.eigh(A32)
A2 = Q @ np.diag(L) @ Q.T
results.loc["numpy32"] = [relerr_np(A2, A32), relerr_np(np.diag(L)@Q.T, Q.T @ A32), relerr_np(Q@Q.T, np.eye(N))]

Q_cpu = torch.from_numpy(Q).to(dtype=torch.float32, device="cpu")
Q_cuda = torch.from_numpy(Q).to(dtype=torch.float32, device="cuda")
I_cpu = torch.eye(len(A32)).to(dtype=torch.float32, device="cpu")
I_cuda = torch.eye(len(A32)).to(dtype=torch.float32, device="cuda")
L_cpu = torch.from_numpy(L).to(dtype=torch.float32, device="cpu")
L_cuda = torch.from_numpy(L).to(dtype=torch.float32, device="cuda")
A_cpu = torch.from_numpy(A32).to(dtype=torch.float32, device="cpu")
A_cuda = torch.from_numpy(A32).to(dtype=torch.float32, device="cuda")

L, Q = torch.linalg.eigh(A_cpu)
A2 = Q @ torch.diag(L) @ Q.T
results.loc["cpu"] =  [relerr(A2, A_cpu), relerr(L, L_cpu), relerr(Q@Q.T, I_cpu)]

L, Q = torch.linalg.eigh(A_cpu, UPLO="U")
A2 = Q @ torch.diag(L) @ Q.T
results.loc["cpu+upper"] =  [relerr(A2, A_cpu), relerr(L, L_cpu), relerr(Q@Q.T, I_cpu)]

L, Q = torch.linalg.eigh(A_cuda)
A2 = Q @ torch.diag(L) @ Q.T
results.loc["gpu"] =  [relerr(A2, A_cuda),relerr(L, L_cuda),relerr(Q@Q.T, I_cuda) ]

L, Q = torch.linalg.eigh(A_cuda, UPLO="U")
A2 = Q @ torch.diag(L) @ Q.T
results.loc["gpu+upper"] = [relerr(A2, A_cuda),relerr(L, L_cuda),relerr(Q@Q.T, I_cuda)]
results
import torch.nn as nn

import torch
import torch.nn.functional as F
inputs = torch.randn(1,2,5,5)

# with `unsqueeze` and `expand`, the final result is wrong
dx = torch.Tensor([[-1, 0, 1], [-2, 0, 2], [-1, 0, 1.]])
dx = (dx * 0.125).unsqueeze(0).expand(2, -1, -1).unsqueeze(1)
F.conv2d(inputs, dx, groups=2)

# output:
# tensor([[[[-8.4053e-02,  1.5646e-01,  4.7885e-01],
#           [ 2.2246e-01, -9.6568e-02,  7.9063e-02],
#           [ 5.4444e-01,  3.5346e-02,  3.4423e-02]],

#          [[ 1.0370e-43,  2.5364e-43,  2.1440e-43],
#           [ 1.7796e-43, -3.7835e-44, -7.2868e-44],
#           [-1.0089e-43, -1.4433e-43, -1.0790e-43]]]])

# if we specify `dx` manually, the final result is correct
dx = torch.Tensor([[[[-0.1250,  0.0000,  0.1250],
          [-0.2500,  0.0000,  0.2500],
          [-0.1250,  0.0000,  0.1250]]],
        [[[-0.1250,  0.0000,  0.1250],
          [-0.2500,  0.0000,  0.2500],
          [-0.1250,  0.0000,  0.1250]]]])
F.conv2d(inputs, dx, groups=2)

# output:
# tensor([[[[-0.0841,  0.1565,  0.4788],
#           [ 0.2225, -0.0966,  0.0791],
#           [ 0.5444,  0.0353,  0.0344]],

#          [[ 0.0619, -0.2744,  0.1337],
#           [-0.7711, -0.3111,  0.6474],
#           [-0.7516, -0.1451,  0.7493]]]])

import torch
import torch.nn.functional as F
inputs = torch.randn(1,2,5,5)

dx = torch.Tensor([[-1, 0, 1], [-2, 0, 2], [-1, 0, 1.]])
dx = (dx * 0.125).unsqueeze(0).expand(2, -1, -1).unsqueeze(1)
F.conv2d(inputs, dx, groups=2)

# output:
# tensor([[[[ 0.0328, -0.1174, -0.1210],
#           [-0.2678, -0.1610, -0.0125],
#           [-0.5337, -0.2080,  0.4840]],

#          [[-0.3917,  0.4860,  0.6290],
#           [-0.1772,  0.3756,  0.4756],
#           [ 0.1023,  0.0608,  0.0542]]]])

dx = torch.Tensor([[[[-0.1250,  0.0000,  0.1250],
          [-0.2500,  0.0000,  0.2500],
          [-0.1250,  0.0000,  0.1250]]],
        [[[-0.1250,  0.0000,  0.1250],
          [-0.2500,  0.0000,  0.2500],
          [-0.1250,  0.0000,  0.1250]]]])
F.conv2d(inputs, dx, groups=2)

# output:
# tensor([[[[ 0.0328, -0.1174, -0.1210],
#           [-0.2678, -0.1610, -0.0125],
#           [-0.5337, -0.2080,  0.4840]],

#          [[-0.3917,  0.4860,  0.6290],
#           [-0.1772,  0.3756,  0.4756],
#           [ 0.1023,  0.0608,  0.0542]]]])
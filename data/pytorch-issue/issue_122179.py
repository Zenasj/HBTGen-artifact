import torch
torch.set_default_device('cuda')

def f(x, y):
    x = torch.matmul(x, x)
    x = x / y
    return torch.softmax(x, dim=-1)

torch.manual_seed(1234)
x = torch.tensor([[[[-16.1649,   5.6846,  -5.1022,  -9.1134],
          [-11.5552,  -2.2615, -12.8913,  10.6538],
          [ -7.1666,  -5.3333,   2.0776,  -9.7984],
          [  7.4469,  -2.3948,   2.7371,   0.9201]],

         [[ -8.0361, -16.3771,  22.7741,   4.4685],
          [ 20.8047,  -0.7771,  -2.4355,  -2.2299],
          [  3.8343,  -2.0914,  -2.4077,   2.2740],
          [-15.8663,  -2.7015, -12.5241,  -3.0040]],

         [[ -2.5139,  14.4393,  -3.7186,   1.2255],
          [  5.6742,  14.1842,  -8.5976,  16.8366],
          [ -9.7358,  -3.0279,  11.8164,  -4.0787],
          [ -9.0621,   8.2580,  29.9486,  -2.4107]],

         [[  7.3622,  12.5640, -20.5592,  13.6237],
          [-11.5640,   0.8832,  16.7275,  -2.5009],
          [ -2.0953, -12.2276, -26.2633,   4.5268],
          [ 15.3329, -11.7492,   6.5650,  -9.2483]]],


        [[[  7.9980,  -4.9369,   3.1508,   5.2994],
          [  3.8052,   3.9514,   8.4987, -10.5045],
          [ -2.6827,  -4.0010,  -4.0611,   6.4091],
          [-19.0318,   6.4073,   2.8923,   8.0250]],

         [[  7.1650,  -3.4585,   5.7720,  -5.0305],
          [ -0.9765,  -3.0086,  11.7114,   8.0555],
          [ -3.1027,  -3.5514,   9.6182,  -8.8526],
          [ -9.2348,  -6.0239,   6.2528,  -6.7221]],

         [[ 11.5936,  22.4139,  -0.4089,  -4.9889],
          [ 14.8217,  -2.3426, -17.6189,   3.7427],
          [  1.9546, -13.0902,   8.6293,  -7.2457],
          [ -7.6900,  -4.5796,   9.6332, -10.2631]],

         [[  0.8027,  -1.0955,  14.8404,  -0.2673],
          [  3.2143,  -1.8640,  -2.9678,   6.5165],
          [ -3.9865,   6.5230,   6.3019,  -0.4247],
          [  8.3185, -13.5076,  27.0986,  -1.6792]]]], device='cuda:0')
y = torch.tensor([[[ 0.6331]],

        [[ 1.6358]],

        [[-0.3459]],

        [[ 1.0196]]], device='cuda:0', requires_grad=True)
f(x, y).sum().backward()
print(y.grad)
y.grad = None
torch.compile(f)(x, y).sum().backward()
print(y.grad)

tensor([[[-8.1229e-06]],

        [[ 0.0000e+00]],

        [[ 0.0000e+00]],

        [[-2.3746e-06]]], device='cuda:0')

tensor([[[0.0203]],

        [[0.0016]],

        [[0.2055]],

        [[0.0215]]], device='cuda:0')
import torch
import torchvision
import torchvision.transforms as transforms
import torch.nn as nn
import os
import torch.nn.functional as F
gpu_device = torch.device("cuda")
cpu_device = torch.device("cpu")
class PreprocessAndCalculateModel(nn.Module):
    def __init__(self):
        super().__init__()
    def forward(self, x):
        # = x.view(x.size(0), -1
        output = x.digamma()
        return output


real_inputs = torch.Tensor([[[ 2.3909e+00, -2.8207e-01,  8.1521e-01, -4.3617e-01,  1.6528e+00,
           1.5221e-01,  2.2616e+00,  1.7607e+00,  2.3811e-01,  2.2693e+00,
           3.1066e+00, -6.3112e-01,  4.7955e-01,  1.4551e+00,  1.5855e+00,
           1.3452e+00,  1.6488e+00, -1.9698e-01,  2.8256e+00,  2.4374e-01,
          -8.7494e-01,  3.5687e-01,  6.5405e-01, -7.0202e-01,  7.8814e-02,
          -7.6567e-01,  4.1977e-01, -8.3299e-01, -4.6370e-01, -1.0135e-01,
          -9.3757e-02, -4.3964e-01],
         [-4.3606e-01,  1.0984e+00,  1.8233e+00, -1.0065e+00,  1.9424e+00,
           2.8483e-01, -3.0691e-01, -3.3664e-01, -6.3089e-01, -5.1409e-01,
           2.0460e+00,  7.6970e-01, -1.0711e+00,  9.8227e-01,  8.8295e-01,
          -1.0701e+00, -2.3024e-02,  1.5419e+00,  2.0422e-02, -3.6050e-01,
          -5.8050e-01,  9.4978e-01,  8.3198e-01,  6.7899e-01,  4.6206e-01,
           1.5127e+00,  9.6580e-01,  2.4921e-01,  5.5589e-01,  2.0264e+00,
           4.3103e-01,  1.3855e-01],
         [ 4.4312e-01, -1.9011e+00,  7.6008e-02, -8.9822e-01, -1.1838e+00,
           8.3705e-01,  7.2743e-01,  1.0711e+00,  9.2668e-01,  6.1321e-01,
          -1.1126e-02, -7.3659e-01,  2.5915e-01,  1.6920e+00,  9.5950e-01,
           1.3963e+00,  1.4929e+00,  2.2664e+00,  1.5402e+00,  1.5025e+00,
           8.1090e-02,  9.3614e-01,  1.1354e+00,  2.4528e-02, -3.7566e-01,
           3.8232e-01, -5.0542e-01, -3.0442e-01,  2.4829e-01,  1.6071e+00,
           1.0563e-01,  3.0266e-01],
         [-1.2786e+00, -1.4203e+00, -4.6664e-01, -1.4778e+00, -3.0842e-01,
           4.1511e-01, -2.0885e-02,  3.0930e-01,  7.4464e-02, -8.3299e-01,
           2.3123e-01,  1.3349e+00, -4.2134e-01,  4.4094e-02,  9.5341e-01,
           1.0242e+00,  6.8908e-01,  1.0170e+00,  7.1061e-01,  9.0433e-01,
           9.6712e-01, -4.0539e-01,  1.0560e+00,  4.3767e-01,  2.1805e-01,
           1.8263e+00,  4.4412e-01,  1.1699e+00,  3.3113e+00,  2.2209e+00,
           1.0809e+00,  1.9719e+00],
         [ 3.2285e-01,  1.6371e+00, -3.7161e-01, -1.2240e+00,  1.5106e+00,
           2.5132e+00,  1.9041e+00, -1.2307e-01,  4.8221e-01,  9.9673e-01,
           8.1892e-02,  8.6183e-01,  3.5887e-01,  2.4179e+00,  9.5476e-01,
           9.1844e-02, -1.2041e+00,  1.1752e+00,  6.3136e-01,  6.9826e-01,
           1.3448e-01,  1.6079e+00,  2.7468e-01,  8.1378e-01, -1.4339e-01,
           8.7484e-01,  9.4281e-01,  1.3422e+00, -3.5259e-01, -8.7911e-01,
          -7.8728e-01,  4.1892e-01],
         [ 5.3623e-01, -9.6742e-01, -3.5683e-01,  1.0712e+00,  1.1610e+00,
          -3.2413e-01, -2.0069e-01,  1.6263e+00,  2.5444e+00,  1.8730e-02,
           1.9343e+00, -1.1111e+00,  1.7955e+00,  4.9204e-01,  8.4976e-01,
           3.4066e-01,  1.8840e+00,  1.7563e+00,  2.4206e+00,  1.5655e+00,
           1.0073e+00,  2.5333e-01,  1.9456e+00,  2.7153e-05, -4.8036e-01,
          -8.8696e-01,  1.4856e-01, -5.6427e-01, -3.0682e-02, -3.1719e-01,
          -1.5909e-05, -1.0949e+00],
         [ 9.0142e-02,  2.2134e-01, -3.2483e-01, -2.7107e-01, -1.0558e-01,
          -3.2744e-01,  4.9716e-01,  1.7767e-01,  2.5779e-01,  3.7116e-01,
          -6.4046e-01,  1.7278e-01,  1.2447e-01, -1.4324e-01,  1.1651e+00,
           2.8146e-01, -5.0399e-01,  8.9215e-01,  1.3983e+00,  3.1872e-01,
          -1.1146e+00,  9.0605e-01,  3.9493e-01,  8.3884e-03, -3.0973e-01,
           5.3624e-01,  3.6783e-01,  1.5282e+00,  2.8060e+00,  1.4527e+00,
           2.0218e+00,  2.3525e+00],
         [ 1.3155e+00,  1.5076e+00, -6.4378e-01, -2.2059e-01,  1.3428e+00,
          -5.7903e-01, -6.7833e-01,  1.2095e+00,  1.9489e+00, -7.5538e-01,
           1.2419e+00, -1.1408e-01,  9.4583e-02, -1.5172e-01, -8.6443e-01,
          -4.7073e-01,  1.4307e+00,  7.9314e-01,  1.0506e-01,  3.9167e-01,
          -5.5900e-01, -1.5652e-01,  1.2452e+00,  6.7868e-01,  9.2116e-02,
           1.4702e+00, -8.4845e-01,  1.3725e+00,  7.5148e-01,  9.7029e-01,
           1.0504e+00,  1.8592e+00],
         [ 1.1439e+00,  1.2101e+00,  1.0236e+00,  3.1201e+00,  1.8787e+00,
           5.3439e-02,  2.7631e+00, -6.8567e-01,  4.0256e-01,  1.1460e+00,
           1.1654e+00,  1.9590e+00,  1.2144e+00,  6.6955e-01,  9.5339e-01,
           6.5501e-01, -1.5141e-02, -4.7317e-01,  9.6922e-01,  1.5335e+00,
           1.7591e+00, -9.4880e-01, -3.5744e-01,  8.2355e-01,  1.1703e+00,
           3.5168e-01, -4.7189e-01, -6.2372e-01, -9.5061e-01, -1.1029e+00,
           6.0769e-01,  2.1978e-01],
         [ 6.4497e-01, -1.0597e+00,  2.9709e-01, -1.1666e+00,  1.1588e+00,
           1.3884e+00, -1.3453e-02,  2.2439e+00,  2.7061e+00,  9.5813e-02,
           1.6038e+00, -9.5244e-02,  1.4315e-01,  8.9029e-01,  1.0331e+00,
           5.9640e-01,  2.2591e+00, -1.9988e-01,  1.9035e+00,  8.5830e-01,
           6.2819e-01, -1.6945e-01,  1.5677e+00, -3.8369e-01,  1.1399e+00,
          -1.1637e-01,  3.0390e-01,  1.7474e+00,  3.8430e-01,  6.9496e-01,
           6.5693e-01,  5.4435e-01],
         [ 2.5855e-01, -1.7226e-01, -9.7972e-01, -3.7928e-01, -1.3276e-01,
           1.4770e+00,  1.6326e+00,  9.8031e-01,  1.5744e+00,  4.5569e-01,
           9.3079e-01,  8.5607e-01,  1.1578e+00, -4.1060e-01,  2.8931e-01,
          -6.7948e-03,  7.6906e-01,  1.2299e+00,  4.7273e-01,  7.3543e-01,
           9.2231e-02, -1.2237e-01,  1.3323e+00,  1.2673e+00,  8.8163e-01,
           1.6799e+00,  1.8259e+00,  1.0575e+00,  4.8234e-01,  9.1125e-01,
          -2.7543e-01,  7.0472e-01],
         [ 2.0221e+00,  1.2955e+00,  1.7964e+00,  1.3854e-01,  2.1001e-01,
           1.0968e+00,  7.5685e-02,  1.9187e+00,  1.3653e+00,  1.4683e+00,
           1.7617e+00,  4.2901e-01, -8.5490e-02,  6.0149e-01,  1.3114e+00,
           6.9912e-01,  7.9616e-01,  2.3628e-02,  1.3325e+00,  5.8619e-01,
          -8.8867e-02, -1.0555e-01,  1.7596e-01,  8.6270e-01,  2.4227e+00,
          -2.0390e-02, -5.3779e-01,  1.4203e+00, -1.4820e+00, -8.0953e-01,
          -5.4997e-01, -8.3375e-01],
         [ 8.2895e-01,  1.6421e+00,  1.0432e+00,  1.6295e+00,  1.5916e-01,
          -3.4100e-01, -3.0621e-01,  2.4011e+00,  5.1872e-01, -3.3991e-01,
           1.4097e+00, -5.4279e-01,  3.6564e-02,  2.5356e+00, -5.2786e-01,
           1.1211e+00,  2.0123e-01, -5.3836e-01, -3.0677e-01,  4.0731e+00,
           8.7008e-02,  1.0474e+00, -4.1481e-02, -2.9937e-01,  2.0552e+00,
          -5.9780e-01,  1.6097e+00, -1.1420e-01, -9.6565e-01, -9.9207e-01,
          -5.3496e-01, -5.8407e-01],
         [ 8.9540e-01,  2.0977e+00,  3.0358e-02,  4.3366e+00,  3.4270e-02,
          -7.4116e-01, -6.3716e-01,  2.3549e+00, -4.7628e-02, -2.6546e-01,
          -2.6757e-01, -3.6328e-01,  2.5207e-02,  1.2357e-01, -5.2923e-01,
          -4.0250e-02, -5.0872e-03,  3.1450e+00, -3.4010e-01,  1.1880e+00,
          -3.2068e-01,  2.5129e-02, -1.1608e-01,  1.3200e+00, -6.6086e-01,
           3.4120e-02, -6.4011e-01,  2.6434e-01,  1.9505e-01, -8.0819e-02,
           1.9215e+00,  9.3727e-01],
         [-2.3510e-01,  3.0082e-01,  1.0321e-01,  1.5850e-02,  1.3468e-01,
           1.7661e-01,  1.9921e-01,  2.3753e-01,  3.1923e-01,  1.3351e+00,
           1.6594e+00, -1.5256e-01,  2.6992e+00,  3.9165e+00,  7.5844e-01,
           4.8413e-01,  4.2646e-01,  8.4793e-02,  4.2455e-01,  1.5091e+00,
           3.8884e-01,  2.3986e+00, -2.7761e-01,  5.0376e-02, -1.6198e-02,
           4.2432e-02, -5.4222e-02,  8.5124e-02, -2.8882e-01, -4.4369e-01,
          -2.9301e-02, -6.5263e-02],
         [ 1.6158e+00, -1.3599e-01, -6.8680e-01,  4.5456e-01, -4.2024e-01,
          -6.9975e-01,  9.2764e-01, -7.5433e-01, -7.4327e-01,  5.5753e-01,
          -9.1579e-01, -6.4495e-01,  2.5303e+00, -4.8543e-01,  1.3222e+00,
           3.3722e-01, -4.6543e-01,  2.0873e+00,  2.4701e+00, -5.4157e-01,
          -3.0087e-01, -7.6478e-01,  1.2198e+00,  1.1018e+00, -4.0234e-01,
           6.0354e-01,  1.4991e-01, -5.6812e-01,  1.0951e+00,  1.9932e+00,
           2.1777e+00,  1.6070e+00]],

        [[ 2.8326e-01,  9.2541e-01,  5.0752e-01,  4.1579e-02,  9.7978e-01,
           2.1384e+00,  2.1830e+00,  1.6500e+00,  1.3309e+00,  1.1218e+00,
           1.6013e+00, -6.5317e-01,  2.2784e-01, -6.4926e-01,  7.9206e-01,
          -1.5494e-01, -5.7990e-01, -1.8472e-01,  1.2975e+00, -7.3253e-01,
           1.2309e+00,  9.9513e-01,  3.0369e-01, -4.2186e-01,  1.7075e+00,
           2.5132e+00, -4.8668e-01, -1.3821e-01,  1.5873e-01, -7.8183e-01,
          -6.1098e-02, -4.9347e-01],
         [ 2.2675e-03, -3.5379e-01,  1.2455e+00,  4.5040e-01, -1.8601e-01,
           3.7661e-01,  1.6181e+00,  3.4324e+00, -6.5722e-01, -2.1743e-01,
           1.3328e+00,  4.0410e-01, -1.2696e+00,  4.3962e+00,  1.1764e+00,
           6.9556e-01,  1.1517e+00,  1.2322e+00, -9.1640e-01,  4.3973e-01,
           7.1018e-01, -4.3582e-01,  8.0934e-01, -3.1133e-01,  2.2437e-01,
           5.4558e-02,  8.0957e-01,  4.6290e-02,  2.0018e-01,  5.1473e-01,
           8.3872e-01,  1.4866e+00],
         [-6.8279e-01, -1.0234e+00, -6.0028e-01, -2.1501e-01,  9.8751e-01,
           6.4578e-01,  2.5537e+00, -7.0952e-01,  8.6514e-01,  1.5867e+00,
           9.9243e-01,  7.5913e-01,  1.1662e+00,  3.9942e-02,  2.3146e+00,
           2.5789e-01,  1.4168e-01,  6.9442e-01,  1.6602e+00,  5.0015e-01,
           1.4011e-01,  9.7094e-01,  4.9696e-01,  6.0959e-01,  1.1223e+00,
          -1.8999e-01,  6.6250e-01,  9.6292e-01,  1.2239e+00, -5.2186e-01,
           8.5539e-01, -1.8664e-01],
         [-6.2090e-01, -1.1857e+00, -4.9001e-01, -1.1614e+00, -1.5619e-01,
           3.1164e-01,  2.6754e-02, -9.1591e-01,  2.0840e-01,  3.6914e-01,
           6.5350e-01,  1.2111e+00,  6.0539e-01,  1.5140e+00,  2.2192e+00,
          -1.0140e+00, -3.0184e-01,  1.1593e+00,  6.3650e-01,  5.7144e-01,
          -1.9830e-01, -8.4694e-01,  5.1253e-01,  8.4093e-01,  3.0773e-01,
          -8.7823e-01,  2.2474e+00,  6.0731e-01,  1.9166e+00,  1.3101e+00,
           1.8573e+00,  1.9677e+00],
         [ 1.8809e+00,  4.1901e-01, -3.6695e-02,  6.3942e-02,  9.7737e-01,
           2.6413e-01,  1.2116e-01,  3.7778e-01,  6.6138e-01,  1.1692e+00,
           7.7241e-01,  4.8937e-01, -4.2451e-02,  8.2936e-01,  1.3753e+00,
           5.2185e-01,  5.0404e-01,  7.6494e-01,  1.7509e+00,  1.0789e+00,
           5.5818e-01,  9.2785e-01,  1.9551e-01,  1.8853e+00, -5.0594e-01,
           2.8226e+00,  1.9965e+00,  4.2422e-01, -8.4108e-01, -1.3550e+00,
           4.5846e-01, -1.2892e-01],
         [ 7.0475e-01,  5.4351e-01, -4.7293e-01, -6.7157e-01,  1.7702e-01,
           1.3771e+00,  1.1193e+00, -1.0516e+00,  1.1226e+00,  1.5043e+00,
          -3.6341e-01, -4.3946e-01,  2.2450e+00,  4.3829e-01,  1.9271e+00,
          -5.9008e-01,  5.7166e-01, -8.7963e-02,  6.5009e-01,  5.1804e-02,
           1.1292e+00,  9.4052e-01,  1.0122e+00, -9.0899e-01,  4.9781e-01,
           1.7958e+00,  1.5629e+00, -6.2930e-01, -1.9166e-01, -2.6672e-02,
           2.7414e-01, -1.0253e+00],
         [-2.5196e-01, -9.8079e-02,  2.8451e-01,  3.1663e-01, -3.0556e-01,
          -7.5932e-01,  2.4413e-01,  2.1478e-01, -4.5738e-01,  1.4471e+00,
           3.4984e-01,  4.3505e-01,  1.4939e+00, -2.7459e-01,  4.4161e-01,
          -6.7181e-01, -1.0834e-01,  9.7960e-01,  8.0802e-02, -1.8747e-01,
           8.3325e-02,  1.2765e-01,  1.0372e-02,  5.2305e-01, -7.0641e-01,
          -1.3449e-01,  9.7508e-01,  7.3392e-01,  1.4709e+00,  1.0559e+00,
           4.3394e+00,  3.8770e+00],
         [-3.2948e-02, -6.8692e-01,  1.0646e+00, -5.0711e-01,  1.2809e+00,
           1.5806e-01, -8.8737e-01,  1.3355e+00,  3.9861e-01,  1.1977e-01,
           3.2207e-01, -7.7221e-01, -1.5718e-01,  2.4215e+00,  9.8507e-01,
           3.3157e-01,  1.1449e+00, -8.0594e-01,  4.7608e-01, -5.6313e-02,
           3.8580e-01, -8.8477e-01,  8.4064e-01,  2.1768e+00,  1.5394e+00,
          -7.4241e-01,  1.8261e+00,  5.7143e-02,  2.4061e-01,  3.8287e+00,
           2.5255e+00,  2.2621e+00],
         [ 1.0991e+00,  2.4128e+00,  1.3325e+00,  1.2950e-01,  4.1600e-01,
           1.6703e+00, -2.9347e-01,  2.1812e-01,  5.9285e-01, -2.8978e-01,
           1.4483e+00,  2.3159e-01, -6.5467e-01,  2.5829e-01, -8.8491e-01,
           1.2396e+00,  5.1278e-01, -1.0693e+00,  2.2233e+00,  3.8081e-01,
           6.1286e-01,  7.2590e-01,  1.8154e+00,  1.2061e-01,  8.2323e-01,
          -5.6497e-01,  2.8069e-01, -8.6383e-01, -1.1062e+00, -9.6138e-01,
          -6.3309e-01,  2.4728e-01],
         [ 8.1777e-01, -4.2179e-01, -6.6450e-01, -1.1983e+00,  1.0928e+00,
           6.4774e-01,  6.1023e-01,  8.6093e-02,  1.1176e+00, -1.5566e-02,
          -6.0362e-01,  4.0164e-01,  2.0285e+00,  1.2492e+00,  1.3457e+00,
          -4.5377e-01,  4.5153e-01,  2.3914e+00, -2.1273e-01,  1.0846e+00,
           1.4489e+00,  5.1611e-01,  1.0274e+00, -2.9840e-01,  5.7536e-01,
           3.7455e-01,  9.9907e-01,  1.2970e+00,  4.2394e-01, -2.4863e-01,
           8.0124e-02,  1.0774e-01],
         [-8.1207e-01, -6.5906e-02, -3.5223e-01, -3.6587e-01, -8.3502e-02,
          -9.5853e-01, -5.8429e-01, -7.2279e-02,  8.4308e-01,  1.3430e+00,
           8.0691e-02,  6.9300e-01,  7.0697e-01,  7.6764e-01,  7.8108e-01,
           2.0196e+00,  5.8316e-01, -4.8821e-01,  2.1151e+00, -4.3070e-01,
           1.4927e-02,  1.1991e+00, -3.0457e-02,  9.4538e-01,  4.5102e-01,
           6.7675e-01,  7.6172e-01,  5.8245e-01,  9.2753e-02,  4.5224e-01,
           2.3329e+00, -2.4599e-02],
         [ 1.3451e+00,  1.4123e+00,  9.5229e-01,  7.2687e-02,  1.8378e-01,
           1.9485e+00,  9.6204e-01,  1.1848e+00, -4.5297e-01,  7.4475e-01,
           1.7006e+00, -1.5263e-01, -4.7258e-01,  1.8451e-01,  5.5303e-01,
           7.9687e-01, -5.6126e-01, -7.5144e-01,  5.4356e-01,  7.1734e-01,
          -6.1953e-01, -3.3586e-01,  7.4412e-01,  6.0888e-01,  9.4997e-01,
           4.8397e-02,  8.0147e-01,  1.6229e-01, -3.3387e-01, -2.8765e-01,
          -7.4963e-01, -7.7953e-01],
         [ 3.9357e-01,  8.0096e-01,  8.2147e-01,  1.7104e+00,  1.2859e+00,
           4.6338e-01,  1.8561e+00,  1.4393e+00,  9.6887e-03, -3.3156e-01,
           9.2987e-01,  1.5775e+00,  9.8151e-02, -5.8774e-01, -6.1478e-01,
           3.4318e+00,  8.3395e-01, -6.0001e-01,  4.2107e-01,  2.1465e+00,
           1.8005e+00, -8.7604e-02,  4.2236e-02, -3.2054e-01,  1.6623e-01,
           1.5998e+00, -2.8969e-01, -3.4449e-01, -4.7170e-01, -7.8544e-01,
          -2.7576e-01, -5.9184e-01],
         [ 2.1352e+00,  2.2970e+00,  1.3453e+00,  3.4147e+00, -5.4887e-02,
          -1.0755e-01, -3.5269e-01,  4.7915e-01,  3.7471e-03, -1.4259e-01,
           1.8796e-01,  1.5783e-01,  1.1271e-01, -1.4450e-01, -7.0677e-01,
           2.0746e+00, -2.1560e-01, -5.8316e-01, -2.5044e-01,  1.4952e+00,
           6.8074e-01, -3.4979e-01, -7.2406e-01,  9.7576e-01,  1.4152e+00,
          -5.5567e-02, -4.8867e-01,  1.0238e-02, -3.4573e-01,  2.7969e+00,
           7.9532e-01,  1.1076e+00],
         [ 3.5689e-01, -1.6830e-01, -1.9635e-01,  1.0679e+00,  6.0875e-01,
           2.1390e+00,  1.0488e+00,  3.7939e-01, -4.4782e-01,  2.6702e+00,
          -1.7241e-01,  2.3422e+00, -5.1919e-01,  4.3674e-01,  6.0060e-01,
           2.5778e+00, -2.4129e-01,  3.7663e-01,  6.7748e-02,  2.0854e-01,
           3.2332e-01,  2.3181e+00,  6.2691e-01, -1.0563e-01,  3.5143e-01,
           3.2119e+00,  3.6300e-02,  1.3791e-01, -3.9132e-01, -2.1059e-01,
          -5.2341e-01, -3.1149e-02],
         [ 9.7893e-01,  1.2792e+00, -3.3370e-01,  4.9989e-02,  7.4475e-01,
          -5.5938e-01, -4.9925e-01, -7.2188e-01, -2.1338e-01,  2.0618e+00,
           1.4555e+00, -4.4737e-01,  1.2471e+00, -7.5505e-01, -3.6947e-01,
          -6.6040e-01, -6.1241e-01,  1.4279e+00,  1.7764e+00, -4.7217e-01,
          -4.0606e-01,  1.3484e+00, -6.7200e-01, -6.5391e-02, -4.3390e-01,
           1.5634e+00, -4.2735e-01, -6.8600e-01,  1.6733e+00,  2.0931e+00,
           3.0127e+00,  1.9636e+00]]])
model = PreprocessAndCalculateModel()
x = real_inputs
output_gpu = model.to(gpu_device)(x.cuda())
output_cpu = model.to(cpu_device)(x.cpu())
print(torch.allclose(output_gpu.cpu(), output_cpu, atol=1e-7))

print((output_gpu.a.cpu()-output_cpu.a).abs().max())
print((output_gpu.tau.cpu()-output_cpu.tau).abs().max())
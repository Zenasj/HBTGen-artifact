import torch.nn as nn

py
import torch

torch.manual_seed(420)

class Model(torch.nn.Module):

    def __init__(self):
        super().__init__()

    def forward(self, x):
        v1 = torch.matmul(x, x.transpose(-1, -2))
        v2 = v1 / -0.0001
        v3 = v2.softmax(dim=-1)
        v4 = torch.matmul(v3, x)
        return v4

func = Model().to('cpu')

x = torch.randn(1, 3, 64, 64)

test_inputs = [x]

with torch.no_grad():
    func.train(False)
    jit_func = torch.compile(func)

    res1 = func(x) # without jit
    print(res1)
    # tensor([[[[-0.4655, -1.1350, -0.9982,  ..., -1.7541, -1.5332,  0.8824],
    #           [ 1.3429, -1.4892, -1.2500,  ..., -0.5561, -1.4006,  0.3309],
    #           [ 1.3429, -1.4892, -1.2500,  ..., -0.5561, -1.4006,  0.3309],
    #           ...,
    #           [ 0.2517,  0.0069,  1.0887,  ..., -0.5190,  0.1727, -0.5762],
    #           [ 1.7818,  1.1335, -1.0080,  ...,  2.5257,  0.5339, -1.4125],
    #           [ 0.5597,  0.2945,  1.1403,  ..., -0.7962, -1.5412, -0.3925]],
    # 
    #          [[-0.6230, -1.9249, -0.3286,  ..., -1.0716, -0.0655, -1.7286],
    #           [ 1.3485, -1.3512,  0.3916,  ..., -0.3752,  0.1259,  1.5306],
    #           [ 0.0446,  0.7670, -1.8892,  ...,  0.2005,  1.7442, -2.2904],
    #           ...,
    #           [-0.1974,  1.1985, -0.0783,  ...,  1.0809,  0.5481,  1.8275],
    #           [-0.2876,  0.7077, -2.5406,  ..., -1.6377, -1.0338, -1.2810],
    #           [-0.1646, -1.6991,  0.3815,  ..., -0.3185, -0.0520, -0.8371]],
    # 
    #          [[ 0.0433,  0.4435,  1.2171,  ..., -0.1094,  1.5639,  1.6918],
    #           [-1.0094, -1.3880, -0.1377,  ..., -0.4373,  0.0737, -1.1173],
    #           [-1.8482,  0.3627,  0.5636,  ...,  0.6504, -0.9623, -0.8336],
    #           ...,
    #           [ 0.3773, -0.6312, -2.1172,  ..., -2.3102, -0.7575, -0.7120],
    #           [-0.7257,  1.8288, -1.2434,  ...,  0.9904, -3.1187,  1.2762],
    #           [ 1.0475, -1.4160,  0.3584,  ..., -0.5997,  0.4141, -0.3347]]]])

    res2 = jit_func(x)
    print(res2)
    # tensor([[[[nan, nan, nan,  ..., nan, nan, nan],)